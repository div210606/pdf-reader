<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Reader - Universal Document Viewer</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="A modern PDF reader with annotations and productivity features">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PDF Reader">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    <!-- Local PDF.js for offline support -->
    <script src="assets/pdfjs/pdf.min.js"></script>
    <!-- Mobile optimizations -->
    <script src="mobile.js"></script>
    <!-- Update checker for web/PWA version -->
    <script src="updater.js"></script>
</head>
<body>
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Handle Electron file opening
        if (window.electronAPI) {
            window.electronAPI.onFileOpened((filePath) => {
                // Handle file opened from Electron
                const fileInput = document.getElementById('fileInput');
                const dataTransfer = new DataTransfer();
                const file = new File([''], filePath);
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                // Trigger file change event
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);
            });
        }
    </script>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 class="app-title">üìö Universal Document Reader</h1>
                <div class="header-actions">
                    <input type="file" id="fileInput" accept=".pdf,.epub,.txt,.doc,.docx" multiple style="display: none;">
                    <button class="btn btn-primary" id="openFileBtn">
                        <span>üìÅ</span> Open File
                    </button>
                    <button class="btn btn-secondary" id="downloadBtn" style="display: none;">
                        <span>üíæ</span> Download
                    </button>
                </div>
            </div>
        </header>

        <!-- Toolbar -->
        <div class="toolbar" id="toolbar" style="display: none;">
            <div class="toolbar-section">
                <button class="toolbar-btn" id="prevPage" title="Previous Page">
                    <span>‚óÄ</span> Previous
                </button>
                <div class="page-info">
                    <span id="pageNum">1</span> / <span id="pageCount">0</span>
                </div>
                <button class="toolbar-btn" id="nextPage" title="Next Page">
                    Next <span>‚ñ∂</span>
                </button>
            </div>
            
            <div class="toolbar-section">
                <button class="toolbar-btn" id="zoomOut" title="Zoom Out">
                    <span>‚àí</span>
                </button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="toolbar-btn" id="zoomIn" title="Zoom In">
                    <span>+</span>
                </button>
                <button class="toolbar-btn" id="fitWidth" title="Fit to Width">
                    Fit Width
                </button>
                <button class="toolbar-btn" id="fitPage" title="Fit to Page">
                    Fit Page
                </button>
            </div>

            <div class="toolbar-section">
                <button class="toolbar-btn" id="rotateBtn" title="Rotate">
                    <span>‚Üª</span> Rotate
                </button>
                <button class="toolbar-btn" id="fullscreenBtn" title="Fullscreen">
                    <span>‚õ∂</span> Fullscreen
                </button>
            </div>
        </div>

        <!-- Annotation Toolbar -->
        <div class="annotation-toolbar" id="annotationToolbar" style="display: none;">
            <div class="toolbar-section">
                <button class="toolbar-btn" id="selectTool" title="Select Tool (S)">
                    <span>‚Üñ</span> Select
                </button>
                <button class="toolbar-btn active" id="textTool" title="Add Text (T)">
                    <span>‚úé</span> Text
                </button>
                <button class="toolbar-btn" id="highlightTool" title="Highlight (H)">
                    <span>üñç</span> Highlight
                </button>
                <button class="toolbar-btn" id="lineTool" title="Draw Line (L)">
                    <span>‚îÄ</span> Line
                </button>
                <button class="toolbar-btn" id="circleTool" title="Draw Circle (C)">
                    <span>‚óã</span> Circle
                </button>
                <button class="toolbar-btn" id="rectTool" title="Draw Rectangle (R)">
                    <span>‚ñ≠</span> Rectangle
                </button>
                <button class="toolbar-btn" id="noteTool" title="Add Note (N)">
                    <span>üìå</span> Note
                </button>
                <button class="toolbar-btn" id="imageTool" title="Insert Image (I)">
                    <span>üñº</span> Image
                </button>
                <button class="toolbar-btn" id="linkTool" title="Add Link (K)">
                    <span>üîó</span> Link
                </button>
                <button class="toolbar-btn" id="ocrTool" title="OCR Text Recognition (O)">
                    <span>üëÅ</span> OCR
                </button>
                <button class="toolbar-btn" id="summarizeTool" title="AI Summarize (M)">
                    <span>ü§ñ</span> Summarize
                </button>
            </div>
            
            <div class="toolbar-section">
                <input type="color" id="colorPicker" value="#ffff00" title="Color">
                <input type="number" id="strokeWidth" min="1" max="20" value="3" title="Stroke Width">
                <button class="toolbar-btn" id="clearAnnotations" title="Clear All Annotations">
                    <span>üóë</span> Clear
                </button>
                <button class="toolbar-btn" id="saveAnnotations" title="Save Annotations">
                    <span>üíæ</span> Save
                </button>
                <button class="toolbar-btn" id="portfolioBtn" title="Open PDF Portfolio">
                    <span>üìö</span> Portfolio
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <div class="welcome-icon">üìñ</div>
                    <h2>Welcome to PDF Reader</h2>
                    <p>Open a PDF, EPUB, or other document file to get started</p>
                    <button class="btn btn-large" id="welcomeOpenBtn">
                        <span>üìÅ</span> Choose a File
                    </button>
                    <div class="supported-formats">
                        <p>Supported formats:</p>
                        <div class="format-tags">
                            <span class="format-tag">PDF</span>
                            <span class="format-tag">EPUB</span>
                            <span class="format-tag">TXT</span>
                            <span class="format-tag">DOC</span>
                            <span class="format-tag">DOCX</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="viewer-container" id="viewerContainer" style="display: none;">
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="pdfCanvas"></canvas>
                        <canvas id="annotationCanvas"></canvas>
                        <div id="textAnnotationsLayer" class="text-annotations-layer"></div>
                        <div id="notesLayer" class="notes-layer"></div>
                    </div>
                </div>
                
                <!-- Text content viewer for non-PDF files -->
                <div class="text-viewer" id="textViewer" style="display: none;">
                    <div class="text-viewer-wrapper">
                        <pre id="textContent"></pre>
                        <canvas id="textAnnotationCanvas"></canvas>
                        <div id="textTextAnnotationsLayer" class="text-annotations-layer"></div>
                        <div id="textNotesLayer" class="notes-layer"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidebar for file list (if multiple files) -->
        <aside class="sidebar" id="sidebar" style="display: none;">
            <div class="sidebar-header">
                <h3>Files</h3>
                <button class="close-sidebar" id="closeSidebar">√ó</button>
            </div>
            <ul class="file-list" id="fileList"></ul>
        </aside>

        <!-- Loading overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="spinner"></div>
            <p>Loading document...</p>
        </div>

        <!-- Text Input Modal -->
        <div class="text-input-modal" id="textInputModal" style="display: none;">
            <div class="modal-content">
                <h3>Add Text</h3>
                <textarea id="textInput" placeholder="Enter your text here..."></textarea>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="confirmText">Add</button>
                    <button class="btn btn-secondary" id="cancelText">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Note Input Modal -->
        <div class="note-input-modal" id="noteInputModal" style="display: none;">
            <div class="modal-content">
                <h3>Add Note</h3>
                <textarea id="noteInput" placeholder="Enter your note..."></textarea>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="confirmNote">Add Note</button>
                    <button class="btn btn-secondary" id="cancelNote">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Image Input -->
        <input type="file" id="imageInput" accept="image/*" style="display: none;">
        
        <!-- OCR Image Input -->
        <input type="file" id="ocrImageInput" accept="image/*" style="display: none;">
        
        <!-- Link Input Modal -->
        <div class="link-input-modal" id="linkInputModal" style="display: none;">
            <div class="modal-content">
                <h3>Add Link</h3>
                <input type="text" id="linkUrl" placeholder="Enter URL (e.g., https://example.com)" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 0.375rem;">
                <input type="text" id="linkText" placeholder="Link text (optional)" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 0.375rem;">
                <div class="modal-actions">
                    <button class="btn btn-primary" id="confirmLink">Add Link</button>
                    <button class="btn btn-secondary" id="cancelLink">Cancel</button>
                </div>
            </div>
        </div>

        <!-- OCR Result Modal -->
        <div class="ocr-result-modal" id="ocrResultModal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <h3>OCR Text Recognition Result</h3>
                <div class="ocr-result-content" id="ocrResultContent" style="max-height: 400px; overflow-y: auto; padding: 1rem; background: var(--background); border-radius: 0.375rem; margin-bottom: 1rem; white-space: pre-wrap; font-family: monospace;"></div>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="copyOcrResult">Copy Text</button>
                    <button class="btn btn-secondary" id="closeOcrResult">Close</button>
                </div>
            </div>
        </div>

        <!-- AI Summarize Modal -->
        <div class="summarize-modal" id="summarizeModal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <h3>AI Summary</h3>
                <div class="summarize-options" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem;">
                        <input type="radio" name="summarizeScope" value="page" checked> Current Page
                    </label>
                    <label style="display: block; margin-bottom: 0.5rem;">
                        <input type="radio" name="summarizeScope" value="all"> Entire Document
                    </label>
                    <label style="display: block; margin-bottom: 0.5rem;">
                        <input type="radio" name="summarizeScope" value="selection"> Selected Text
                    </label>
                </div>
                <div class="summarize-result" id="summarizeResult" style="max-height: 400px; overflow-y: auto; padding: 1rem; background: var(--background); border-radius: 0.375rem; margin-bottom: 1rem; min-height: 100px;"></div>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="generateSummary">Generate Summary</button>
                    <button class="btn btn-secondary" id="closeSummarize">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- EPUB.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.93/epub.min.js"></script>
    <!-- Mammoth.js library for Word documents -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
